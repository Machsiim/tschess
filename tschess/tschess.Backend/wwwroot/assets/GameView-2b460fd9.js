var Ht=Object.defineProperty;var Ut=(e,t,o)=>t in e?Ht(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var ve=(e,t,o)=>(Ut(e,typeof t!="symbol"?t+"":t,o),o);import{f as dt,g as be,h as jt,o as Ce,c as ht,a as se,i as xe,b as ut,n as ye,T as Qt,j as Vt,k as zt,l as Zt,s as _e,m as Xt,u as Yt}from"./index-a0e500f0.js";const Jt=dt({__name:"PromotionDialog",props:{turnColor:{type:String,required:!0}},emits:["promotionSelected"],setup(e,{emit:t}){const o=be(null);function r(n){var d;if(n.target==null)return;const i=n.target.getAttribute("data-piece");i!=null&&((d=o.value)==null||d.close(),t("promotionSelected",i))}return(n,i)=>(Ce(),xe(Qt,{to:"cg-board"},[se("dialog",{ref_key:"dialogEl",ref:o,class:"promotion-dialog",open:"",onClick:r,onTouchstartPassive:r},[se("button",{class:ye(["queen",e.turnColor]),"data-piece":"q","aria-label":"Queen"},null,2),se("button",{class:ye(["knight",e.turnColor]),"data-piece":"n","aria-label":"Knight"},null,2),se("button",{class:ye(["rook",e.turnColor]),"data-piece":"r","aria-label":"Rook"},null,2),se("button",{class:ye(["bishop",e.turnColor]),"data-piece":"b","aria-label":"Bishop"},null,2)],544)]))}});var Be={};(function(e){/**
 * @license
 * Copyright (c) 2023, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */Object.defineProperty(e,"__esModule",{value:!0}),e.Chess=e.validateFen=e.SQUARES=e.DEFAULT_POSITION=e.KING=e.QUEEN=e.ROOK=e.BISHOP=e.KNIGHT=e.PAWN=e.BLACK=e.WHITE=void 0,e.WHITE="w",e.BLACK="b",e.PAWN="p",e.KNIGHT="n",e.BISHOP="b",e.ROOK="r",e.QUEEN="q",e.KING="k",e.DEFAULT_POSITION="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";const t=-1,o={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"};e.SQUARES=["a8","b8","c8","d8","e8","f8","g8","h8","a7","b7","c7","d7","e7","f7","g7","h7","a6","b6","c6","d6","e6","f6","g6","h6","a5","b5","c5","d5","e5","f5","g5","h5","a4","b4","c4","d4","e4","f4","g4","h4","a3","b3","c3","d3","e3","f3","g3","h3","a2","b2","c2","d2","e2","f2","g2","h2","a1","b1","c1","d1","e1","f1","g1","h1"];const r={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},n={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},i={b:[16,32,17,15],w:[-16,-32,-17,-15]},d={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},f=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],m=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],v={p:1,n:2,b:4,r:8,q:16,k:32},E="pnbrqkPNBRQK",k=[e.KNIGHT,e.BISHOP,e.ROOK,e.QUEEN],M=7,D=6,y=1,S=0,G={w:[{square:n.a1,flag:r.QSIDE_CASTLE},{square:n.h1,flag:r.KSIDE_CASTLE}],b:[{square:n.a8,flag:r.QSIDE_CASTLE},{square:n.h8,flag:r.KSIDE_CASTLE}]},ee={b:y,w:D},$=["1-0","0-1","1/2-1/2","*"];function F(N){return N>>4}function X(N){return N&15}function H(N){return"0123456789".indexOf(N)!==-1}function R(N){const s=X(N),l=F(N);return"abcdefgh".substring(s,s+1)+"87654321".substring(l,l+1)}function Y(N){return N===e.WHITE?e.BLACK:e.WHITE}function T(N){const s=N.split(/\s+/);if(s.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const l=parseInt(s[5],10);if(isNaN(l)||l<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const a=parseInt(s[4],10);if(isNaN(a)||a<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(s[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(s[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(s[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const c=s[0].split("/");if(c.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let g=0;g<c.length;g++){let p=0,u=!1;for(let w=0;w<c[g].length;w++)if(H(c[g][w])){if(u)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};p+=parseInt(c[g][w],10),u=!0}else{if(!/^[prnbqkPRNBQK]$/.test(c[g][w]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};p+=1,u=!1}if(p!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(s[3][1]=="3"&&s[1]=="w"||s[3][1]=="6"&&s[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const h=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:g,regex:p}of h){if(!p.test(s[0]))return{ok:!1,error:`Invalid FEN: missing ${g} king`};if((s[0].match(p)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${g} kings`}}return{ok:!0}}e.validateFen=T;function de(N,s){const l=N.from,a=N.to,c=N.piece;let h=0,g=0,p=0;for(let u=0,w=s.length;u<w;u++){const A=s[u].from,I=s[u].to,b=s[u].piece;c===b&&l!==A&&a===I&&(h++,F(l)===F(A)&&g++,X(l)===X(A)&&p++)}return h>0?g>0&&p>0?R(l):p>0?R(l).charAt(1):R(l).charAt(0):""}function q(N,s,l,a,c,h=void 0,g=r.NORMAL){const p=F(a);if(c===e.PAWN&&(p===M||p===S))for(let u=0;u<k.length;u++){const w=k[u];N.push({color:s,from:l,to:a,piece:c,captured:h,promotion:w,flags:g|r.PROMOTION})}else N.push({color:s,from:l,to:a,piece:c,captured:h,flags:g})}function U(N){let s=N.charAt(0);return s>="a"&&s<="h"?N.match(/[a-h]\d.*[a-h]\d/)?void 0:e.PAWN:(s=s.toLowerCase(),s==="o"?e.KING:s)}function te(N){return N.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class Ft{constructor(s=e.DEFAULT_POSITION){this._board=new Array(128),this._turn=e.WHITE,this._header={},this._kings={w:t,b:t},this._epSquare=-1,this._halfMoves=0,this._moveNumber=0,this._history=[],this._comments={},this._castling={w:0,b:0},this.load(s)}clear(s=!1){this._board=new Array(128),this._kings={w:t,b:t},this._turn=e.WHITE,this._castling={w:0,b:0},this._epSquare=t,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=s?this._header:{},this._updateSetup(this.fen())}removeHeader(s){s in this._header&&delete this._header[s]}load(s,l=!1){let a=s.split(/\s+/);if(a.length>=2&&a.length<6){const u=["-","-","0","1"];s=a.concat(u.slice(-(6-a.length))).join(" ")}a=s.split(/\s+/);const{ok:c,error:h}=T(s);if(!c)throw new Error(h);const g=a[0];let p=0;this.clear(l);for(let u=0;u<g.length;u++){const w=g.charAt(u);if(w==="/")p+=8;else if(H(w))p+=parseInt(w,10);else{const A=w<"a"?e.WHITE:e.BLACK;this.put({type:w.toLowerCase(),color:A},R(p)),p++}}this._turn=a[1],a[2].indexOf("K")>-1&&(this._castling.w|=r.KSIDE_CASTLE),a[2].indexOf("Q")>-1&&(this._castling.w|=r.QSIDE_CASTLE),a[2].indexOf("k")>-1&&(this._castling.b|=r.KSIDE_CASTLE),a[2].indexOf("q")>-1&&(this._castling.b|=r.QSIDE_CASTLE),this._epSquare=a[3]==="-"?t:n[a[3]],this._halfMoves=parseInt(a[4],10),this._moveNumber=parseInt(a[5],10),this._updateSetup(this.fen())}fen(){var s,l;let a=0,c="";for(let p=n.a8;p<=n.h1;p++){if(this._board[p]){a>0&&(c+=a,a=0);const{color:u,type:w}=this._board[p];c+=u===e.WHITE?w.toUpperCase():w.toLowerCase()}else a++;p+1&136&&(a>0&&(c+=a),p!==n.h1&&(c+="/"),a=0,p+=8)}let h="";this._castling[e.WHITE]&r.KSIDE_CASTLE&&(h+="K"),this._castling[e.WHITE]&r.QSIDE_CASTLE&&(h+="Q"),this._castling[e.BLACK]&r.KSIDE_CASTLE&&(h+="k"),this._castling[e.BLACK]&r.QSIDE_CASTLE&&(h+="q"),h=h||"-";let g="-";if(this._epSquare!==t){const p=this._epSquare+(this._turn===e.WHITE?16:-16),u=[p+1,p-1];for(const w of u){if(w&136)continue;const A=this._turn;if(((s=this._board[w])===null||s===void 0?void 0:s.color)===A&&((l=this._board[w])===null||l===void 0?void 0:l.type)===e.PAWN){this._makeMove({color:A,from:w,to:this._epSquare,piece:e.PAWN,captured:e.PAWN,flags:r.EP_CAPTURE});const I=!this._isKingAttacked(A);if(this._undoMove(),I){g=R(this._epSquare);break}}}}return[c,this._turn,h,g,this._halfMoves,this._moveNumber].join(" ")}_updateSetup(s){this._history.length>0||(s!==e.DEFAULT_POSITION?(this._header.SetUp="1",this._header.FEN=s):(delete this._header.SetUp,delete this._header.FEN))}reset(){this.load(e.DEFAULT_POSITION)}get(s){return this._board[n[s]]||!1}put({type:s,color:l},a){if(E.indexOf(s.toLowerCase())===-1||!(a in n))return!1;const c=n[a];return s==e.KING&&!(this._kings[l]==t||this._kings[l]==c)?!1:(this._board[c]={type:s,color:l},s===e.KING&&(this._kings[l]=c),this._updateSetup(this.fen()),!0)}remove(s){const l=this.get(s);return delete this._board[n[s]],l&&l.type===e.KING&&(this._kings[l.color]=t),this._updateSetup(this.fen()),l}_attacked(s,l){for(let a=n.a8;a<=n.h1;a++){if(a&136){a+=7;continue}if(this._board[a]===void 0||this._board[a].color!==s)continue;const c=this._board[a],h=a-l;if(h===0)continue;const g=h+119;if(f[g]&v[c.type]){if(c.type===e.PAWN){if(h>0){if(c.color===e.WHITE)return!0}else if(c.color===e.BLACK)return!0;continue}if(c.type==="n"||c.type==="k")return!0;const p=m[g];let u=a+p,w=!1;for(;u!==l;){if(this._board[u]!=null){w=!0;break}u+=p}if(!w)return!0}}return!1}_isKingAttacked(s){const l=this._kings[s];return l===-1?!1:this._attacked(Y(s),l)}isAttacked(s,l){return this._attacked(l,n[s])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const s={b:0,n:0,r:0,q:0,k:0,p:0},l=[];let a=0,c=0;for(let h=n.a8;h<=n.h1;h++){if(c=(c+1)%2,h&136){h+=7;continue}const g=this._board[h];g&&(s[g.type]=g.type in s?s[g.type]+1:1,g.type===e.BISHOP&&l.push(c),a++)}if(a===2||a===3&&(s[e.BISHOP]===1||s[e.KNIGHT]===1))return!0;if(a===s[e.BISHOP]+2){let h=0;const g=l.length;for(let p=0;p<g;p++)h+=l[p];if(h===0||h===g)return!0}return!1}isThreefoldRepetition(){const s=[],l={};let a=!1;for(;;){const c=this._undoMove();if(!c)break;s.push(c)}for(;;){const c=this.fen().split(" ").slice(0,4).join(" ");l[c]=c in l?l[c]+1:1,l[c]>=3&&(a=!0);const h=s.pop();if(h)this._makeMove(h);else break}return a}isDraw(){return this._halfMoves>=100||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isStalemate()||this.isDraw()}moves({verbose:s=!1,square:l=void 0,piece:a=void 0}={}){const c=this._moves({square:l,piece:a});return s?c.map(h=>this._makePretty(h)):c.map(h=>this._moveToSan(h,c))}_moves({legal:s=!0,piece:l=void 0,square:a=void 0}={}){var c;const h=a?a.toLowerCase():void 0,g=l==null?void 0:l.toLowerCase(),p=[],u=this._turn,w=Y(u);let A=n.a8,I=n.h1,b=!1;if(h)if(h in n)A=I=n[h],b=!0;else return[];for(let _=A;_<=I;_++){if(_&136){_+=7;continue}if(!this._board[_]||this._board[_].color===w)continue;const{type:O}=this._board[_];let P;if(O===e.PAWN){if(g&&g!==O)continue;P=_+i[u][0],this._board[P]||(q(p,u,_,P,e.PAWN),P=_+i[u][1],ee[u]===F(_)&&!this._board[P]&&q(p,u,_,P,e.PAWN,void 0,r.BIG_PAWN));for(let j=2;j<4;j++)P=_+i[u][j],!(P&136)&&(((c=this._board[P])===null||c===void 0?void 0:c.color)===w?q(p,u,_,P,e.PAWN,this._board[P].type,r.CAPTURE):P===this._epSquare&&q(p,u,_,P,e.PAWN,e.PAWN,r.EP_CAPTURE))}else{if(g&&g!==O)continue;for(let j=0,C=d[O].length;j<C;j++){const W=d[O][j];for(P=_;P+=W,!(P&136);){if(!this._board[P])q(p,u,_,P,O);else{if(this._board[P].color===u)break;q(p,u,_,P,O,this._board[P].type,r.CAPTURE);break}if(O===e.KNIGHT||O===e.KING)break}}}}if((g===void 0||g===e.KING)&&(!b||I===this._kings[u])){if(this._castling[u]&r.KSIDE_CASTLE){const _=this._kings[u],O=_+2;!this._board[_+1]&&!this._board[O]&&!this._attacked(w,this._kings[u])&&!this._attacked(w,_+1)&&!this._attacked(w,O)&&q(p,u,this._kings[u],O,e.KING,void 0,r.KSIDE_CASTLE)}if(this._castling[u]&r.QSIDE_CASTLE){const _=this._kings[u],O=_-2;!this._board[_-1]&&!this._board[_-2]&&!this._board[_-3]&&!this._attacked(w,this._kings[u])&&!this._attacked(w,_-1)&&!this._attacked(w,O)&&q(p,u,this._kings[u],O,e.KING,void 0,r.QSIDE_CASTLE)}}if(!s||this._kings[u]===-1)return p;const L=[];for(let _=0,O=p.length;_<O;_++)this._makeMove(p[_]),this._isKingAttacked(u)||L.push(p[_]),this._undoMove();return L}move(s,{strict:l=!1}={}){let a=null;if(typeof s=="string")a=this._moveFromSan(s,l);else if(typeof s=="object"){const h=this._moves();for(let g=0,p=h.length;g<p;g++)if(s.from===R(h[g].from)&&s.to===R(h[g].to)&&(!("promotion"in h[g])||s.promotion===h[g].promotion)){a=h[g];break}}if(!a)throw typeof s=="string"?new Error(`Invalid move: ${s}`):new Error(`Invalid move: ${JSON.stringify(s)}`);const c=this._makePretty(a);return this._makeMove(a),c}_push(s){this._history.push({move:s,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_makeMove(s){const l=this._turn,a=Y(l);if(this._push(s),this._board[s.to]=this._board[s.from],delete this._board[s.from],s.flags&r.EP_CAPTURE&&(this._turn===e.BLACK?delete this._board[s.to-16]:delete this._board[s.to+16]),s.promotion&&(this._board[s.to]={type:s.promotion,color:l}),this._board[s.to].type===e.KING){if(this._kings[l]=s.to,s.flags&r.KSIDE_CASTLE){const c=s.to-1,h=s.to+1;this._board[c]=this._board[h],delete this._board[h]}else if(s.flags&r.QSIDE_CASTLE){const c=s.to+1,h=s.to-2;this._board[c]=this._board[h],delete this._board[h]}this._castling[l]=0}if(this._castling[l]){for(let c=0,h=G[l].length;c<h;c++)if(s.from===G[l][c].square&&this._castling[l]&G[l][c].flag){this._castling[l]^=G[l][c].flag;break}}if(this._castling[a]){for(let c=0,h=G[a].length;c<h;c++)if(s.to===G[a][c].square&&this._castling[a]&G[a][c].flag){this._castling[a]^=G[a][c].flag;break}}s.flags&r.BIG_PAWN?l===e.BLACK?this._epSquare=s.to-16:this._epSquare=s.to+16:this._epSquare=t,s.piece===e.PAWN?this._halfMoves=0:s.flags&(r.CAPTURE|r.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,l===e.BLACK&&this._moveNumber++,this._turn=a}undo(){const s=this._undoMove();return s?this._makePretty(s):null}_undoMove(){const s=this._history.pop();if(s===void 0)return null;const l=s.move;this._kings=s.kings,this._turn=s.turn,this._castling=s.castling,this._epSquare=s.epSquare,this._halfMoves=s.halfMoves,this._moveNumber=s.moveNumber;const a=this._turn,c=Y(a);if(this._board[l.from]=this._board[l.to],this._board[l.from].type=l.piece,delete this._board[l.to],l.captured)if(l.flags&r.EP_CAPTURE){let h;a===e.BLACK?h=l.to-16:h=l.to+16,this._board[h]={type:e.PAWN,color:c}}else this._board[l.to]={type:l.captured,color:c};if(l.flags&(r.KSIDE_CASTLE|r.QSIDE_CASTLE)){let h,g;l.flags&r.KSIDE_CASTLE?(h=l.to+1,g=l.to-1):(h=l.to-2,g=l.to+1),this._board[h]=this._board[g],delete this._board[g]}return l}pgn({newline:s=`
`,maxWidth:l=0}={}){const a=[];let c=!1;for(const b in this._header)a.push("["+b+' "'+this._header[b]+'"]'+s),c=!0;c&&this._history.length&&a.push(s);const h=b=>{const L=this._comments[this.fen()];if(typeof L<"u"){const _=b.length>0?" ":"";b=`${b}${_}{${L}}`}return b},g=[];for(;this._history.length>0;)g.push(this._undoMove());const p=[];let u="";for(g.length===0&&p.push(h(""));g.length>0;){u=h(u);const b=g.pop();if(!b)break;if(!this._history.length&&b.color==="b"){const L=`${this._moveNumber}. ...`;u=u?`${u} ${L}`:L}else b.color==="w"&&(u.length&&p.push(u),u=this._moveNumber+".");u=u+" "+this._moveToSan(b,this._moves({legal:!0})),this._makeMove(b)}if(u.length&&p.push(h(u)),typeof this._header.Result<"u"&&p.push(this._header.Result),l===0)return a.join("")+p.join(" ");const w=function(){return a.length>0&&a[a.length-1]===" "?(a.pop(),!0):!1},A=function(b,L){for(const _ of L.split(" "))if(_){if(b+_.length>l){for(;w();)b--;a.push(s),b=0}a.push(_),b+=_.length,a.push(" "),b++}return w()&&b--,b};let I=0;for(let b=0;b<p.length;b++){if(I+p[b].length>l&&p[b].includes("{")){I=A(I,p[b]);continue}I+p[b].length>l&&b!==0?(a[a.length-1]===" "&&a.pop(),a.push(s),I=0):b!==0&&(a.push(" "),I++),a.push(p[b]),I+=p[b].length}return a.join("")}header(...s){for(let l=0;l<s.length;l+=2)typeof s[l]=="string"&&typeof s[l+1]=="string"&&(this._header[s[l]]=s[l+1]);return this._header}loadPgn(s,{strict:l=!1,newlineChar:a=`\r?
`}={}){function c(C){return C.replace(/\\/g,"\\")}function h(C){const W={},oe=C.split(new RegExp(c(a)));let Ie="",Ye="";for(let Ee=0;Ee<oe.length;Ee++){const Je=/^\s*\[\s*([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;Ie=oe[Ee].replace(Je,"$1"),Ye=oe[Ee].replace(Je,"$2"),Ie.trim().length>0&&(W[Ie]=Ye)}return W}s=s.trim();const g=new RegExp("^(\\[((?:"+c(a)+")|.)*\\])((?:\\s*"+c(a)+"){2}|(?:\\s*"+c(a)+")*$)").exec(s),p=g&&g.length>=2?g[1]:"";this.reset();const u=h(p);let w="";for(const C in u)C.toLowerCase()==="fen"&&(w=u[C]),this.header(C,u[C]);if(!l)w&&this.load(w,!0);else if(u.SetUp==="1"){if(!("FEN"in u))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(u.FEN,!0)}function A(C){return Array.from(C).map(function(W){return W.charCodeAt(0)<128?W.charCodeAt(0).toString(16):encodeURIComponent(W).replace(/%/g,"").toLowerCase()}).join("")}function I(C){return C.length==0?"":decodeURIComponent("%"+(C.match(/.{1,2}/g)||[]).join("%"))}const b=function(C){return C=C.replace(new RegExp(c(a),"g")," "),`{${A(C.slice(1,C.length-1))}}`},L=function(C){if(C.startsWith("{")&&C.endsWith("}"))return I(C.slice(1,C.length-1))};let _=s.replace(p,"").replace(new RegExp(`({[^}]*})+?|;([^${c(a)}]*)`,"g"),function(C,W,oe){return W!==void 0?b(W):" "+b(`{${oe.slice(1)}}`)}).replace(new RegExp(c(a),"g")," ");const O=/(\([^()]+\))+?/g;for(;O.test(_);)_=_.replace(O,"");_=_.replace(/\d+\.(\.\.)?/g,""),_=_.replace(/\.\.\./g,""),_=_.replace(/\$\d+/g,"");let P=_.trim().split(new RegExp(/\s+/));P=P.filter(C=>C!=="");let j="";for(let C=0;C<P.length;C++){const W=L(P[C]);if(W!==void 0){this._comments[this.fen()]=W;continue}const oe=this._moveFromSan(P[C],l);if(oe==null)if($.indexOf(P[C])>-1)j=P[C];else throw new Error(`Invalid move in PGN: ${P[C]}`);else j="",this._makeMove(oe)}j&&Object.keys(this._header).length&&!this._header.Result&&this.header("Result",j)}_moveToSan(s,l){let a="";if(s.flags&r.KSIDE_CASTLE)a="O-O";else if(s.flags&r.QSIDE_CASTLE)a="O-O-O";else{if(s.piece!==e.PAWN){const c=de(s,l);a+=s.piece.toUpperCase()+c}s.flags&(r.CAPTURE|r.EP_CAPTURE)&&(s.piece===e.PAWN&&(a+=R(s.from)[0]),a+="x"),a+=R(s.to),s.promotion&&(a+="="+s.promotion.toUpperCase())}return this._makeMove(s),this.isCheck()&&(this.isCheckmate()?a+="#":a+="+"),this._undoMove(),a}_moveFromSan(s,l=!1){const a=te(s);let c=U(a),h=this._moves({legal:!0,piece:c});for(let b=0,L=h.length;b<L;b++)if(a===te(this._moveToSan(h[b],h)))return h[b];if(l)return null;let g,p,u,w,A,I=!1;if(p=a.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),p?(g=p[1],u=p[2],w=p[3],A=p[4],u.length==1&&(I=!0)):(p=a.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),p&&(g=p[1],u=p[2],w=p[3],A=p[4],u.length==1&&(I=!0))),c=U(a),h=this._moves({legal:!0,piece:g||c}),!w)return null;for(let b=0,L=h.length;b<L;b++)if(u){if((!g||g.toLowerCase()==h[b].piece)&&n[u]==h[b].from&&n[w]==h[b].to&&(!A||A.toLowerCase()==h[b].promotion))return h[b];if(I){const _=R(h[b].from);if((!g||g.toLowerCase()==h[b].piece)&&n[w]==h[b].to&&(u==_[0]||u==_[1])&&(!A||A.toLowerCase()==h[b].promotion))return h[b]}}else if(a===te(this._moveToSan(h[b],h)).replace("x",""))return h[b];return null}ascii(){let s=`   +------------------------+
`;for(let l=n.a8;l<=n.h1;l++){if(X(l)===0&&(s+=" "+"87654321"[F(l)]+" |"),this._board[l]){const a=this._board[l].type,c=this._board[l].color===e.WHITE?a.toUpperCase():a.toLowerCase();s+=" "+c+" "}else s+=" . ";l+1&136&&(s+=`|
`,l+=8)}return s+=`   +------------------------+
`,s+="     a  b  c  d  e  f  g  h",s}perft(s){const l=this._moves({legal:!1});let a=0;const c=this._turn;for(let h=0,g=l.length;h<g;h++)this._makeMove(l[h]),this._isKingAttacked(c)||(s-1>0?a+=this.perft(s-1):a++),this._undoMove();return a}_makePretty(s){const{color:l,piece:a,from:c,to:h,flags:g,captured:p,promotion:u}=s;let w="";for(const L in r)r[L]&g&&(w+=o[L]);const A=R(c),I=R(h),b={color:l,piece:a,from:A,to:I,san:this._moveToSan(s,this._moves({legal:!0})),flags:w,lan:A+I,before:this.fen(),after:""};return this._makeMove(s),b.after=this.fen(),this._undoMove(),p&&(b.captured=p),u&&(b.promotion=u,b.lan+=u),b}turn(){return this._turn}board(){const s=[];let l=[];for(let a=n.a8;a<=n.h1;a++)this._board[a]==null?l.push(null):l.push({square:R(a),type:this._board[a].type,color:this._board[a].color}),a+1&136&&(s.push(l),l=[],a+=8);return s}squareColor(s){if(s in n){const l=n[s];return(F(l)+X(l))%2===0?"light":"dark"}return null}history({verbose:s=!1}={}){const l=[],a=[];for(;this._history.length>0;)l.push(this._undoMove());for(;;){const c=l.pop();if(!c)break;s?a.push(this._makePretty(c)):a.push(this._moveToSan(c,this._moves())),this._makeMove(c)}return a}_pruneComments(){const s=[],l={},a=c=>{c in this._comments&&(l[c]=this._comments[c])};for(;this._history.length>0;)s.push(this._undoMove());for(a(this.fen());;){const c=s.pop();if(!c)break;this._makeMove(c),a(this.fen())}this._comments=l}getComment(){return this._comments[this.fen()]}setComment(s){this._comments[this.fen()]=s.replace("{","[").replace("}","]")}deleteComment(){const s=this._comments[this.fen()];return delete this._comments[this.fen()],s}getComments(){return this._pruneComments(),Object.keys(this._comments).map(s=>({fen:s,comment:this._comments[s]}))}deleteComments(){return this._pruneComments(),Object.keys(this._comments).map(s=>{const l=this._comments[s];return delete this._comments[s],{fen:s,comment:l}})}}e.Chess=Ft})(Be);const eo=["white","black"],Ge=["a","b","c","d","e","f","g","h"],$e=["1","2","3","4","5","6","7","8"],to=[...$e].reverse(),Fe=Array.prototype.concat(...Ge.map(e=>$e.map(t=>e+t))),Q=e=>Fe[8*e[0]+e[1]],K=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],pt=Fe.map(K);function oo(e){let t;const o=()=>(t===void 0&&(t=e()),t);return o.clear=()=>{t=void 0},o}const ro=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},He=e=>e==="white"?"black":"white",Se=(e,t)=>{const o=e[0]-t[0],r=e[1]-t[1];return o*o+r*r},Le=(e,t)=>e.role===t.role&&e.color===t.color,Pe=e=>(t,o)=>[(o?t[0]:7-t[0])*e.width/8,(o?7-t[1]:t[1])*e.height/8],Z=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},ft=(e,t,o=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${o})`},Ue=(e,t)=>{e.style.visibility=t?"visible":"hidden"},fe=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},gt=e=>e.buttons===2||e.button===2,J=(e,t)=>{const o=document.createElement(e);return t&&(o.className=t),o};function mt(e,t,o){const r=K(e);return t||(r[0]=7-r[0],r[1]=7-r[1]),[o.left+o.width*r[0]/8+o.width/16,o.top+o.height*(7-r[1])/8+o.height/16]}const pe=(e,t)=>Math.abs(e-t),no=e=>(t,o,r,n)=>pe(t,r)<2&&(e==="white"?n===o+1||o<=1&&n===o+2&&t===r:n===o-1||o>=6&&n===o-2&&t===r),bt=(e,t,o,r)=>{const n=pe(e,o),i=pe(t,r);return n===1&&i===2||n===2&&i===1},vt=(e,t,o,r)=>pe(e,o)===pe(t,r),_t=(e,t,o,r)=>e===o||t===r,wt=(e,t,o,r)=>vt(e,t,o,r)||_t(e,t,o,r),so=(e,t,o)=>(r,n,i,d)=>pe(r,i)<2&&pe(n,d)<2||o&&n===d&&n===(e==="white"?0:7)&&(r===4&&(i===2&&t.includes(0)||i===6&&t.includes(7))||t.includes(i));function io(e,t){const o=t==="white"?"1":"8",r=[];for(const[n,i]of e)n[1]===o&&i.color===t&&i.role==="rook"&&r.push(K(n)[0]);return r}function kt(e,t,o){const r=e.get(t);if(!r)return[];const n=K(t),i=r.role,d=i==="pawn"?no(r.color):i==="knight"?bt:i==="bishop"?vt:i==="rook"?_t:i==="queen"?wt:so(r.color,io(e,r.color),o);return pt.filter(f=>(n[0]!==f[0]||n[1]!==f[1])&&d(n[0],n[1],f[0],f[1])).map(Q)}function x(e,...t){e&&setTimeout(()=>e(...t),1)}function ao(e){e.orientation=He(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function lo(e,t){for(const[o,r]of t)r?e.pieces.set(o,r):e.pieces.delete(o)}function co(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(const[o,r]of e.pieces)r.role==="king"&&r.color===t&&(e.check=o)}function ho(e,t,o,r){ce(e),e.premovable.current=[t,o],x(e.premovable.events.set,t,o,r)}function le(e){e.premovable.current&&(e.premovable.current=void 0,x(e.premovable.events.unset))}function uo(e,t,o){le(e),e.predroppable.current={role:t,key:o},x(e.predroppable.events.set,t,o)}function ce(e){const t=e.predroppable;t.current&&(t.current=void 0,x(t.events.unset))}function po(e,t,o){if(!e.autoCastle)return!1;const r=e.pieces.get(t);if(!r||r.role!=="king")return!1;const n=K(t),i=K(o);if(n[1]!==0&&n[1]!==7||n[1]!==i[1])return!1;n[0]===4&&!e.pieces.has(o)&&(i[0]===6?o=Q([7,i[1]]):i[0]===2&&(o=Q([0,i[1]])));const d=e.pieces.get(o);return!d||d.color!==r.color||d.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(o),n[0]<i[0]?(e.pieces.set(Q([6,i[1]]),r),e.pieces.set(Q([5,i[1]]),d)):(e.pieces.set(Q([2,i[1]]),r),e.pieces.set(Q([3,i[1]]),d)),!0)}function yt(e,t,o){const r=e.pieces.get(t),n=e.pieces.get(o);if(t===o||!r)return!1;const i=n&&n.color!==r.color?n:void 0;return o===e.selected&&V(e),x(e.events.move,t,o,i),po(e,t,o)||(e.pieces.set(o,r),e.pieces.delete(t)),e.lastMove=[t,o],e.check=void 0,x(e.events.change),i||!0}function je(e,t,o,r){if(e.pieces.has(o))if(r)e.pieces.delete(o);else return!1;return x(e.events.dropNewPiece,t,o),e.pieces.set(o,t),e.lastMove=[o],e.check=void 0,x(e.events.change),e.movable.dests=void 0,e.turnColor=He(e.turnColor),!0}function Ct(e,t,o){const r=yt(e,t,o);return r&&(e.movable.dests=void 0,e.turnColor=He(e.turnColor),e.animation.current=void 0),r}function St(e,t,o){if(Qe(e,t,o)){const r=Ct(e,t,o);if(r){const n=e.hold.stop();V(e);const i={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:n};return r!==!0&&(i.captured=r),x(e.movable.events.after,t,o,i),!0}}else if(go(e,t,o))return ho(e,t,o,{ctrlKey:e.stats.ctrlKey}),V(e),!0;return V(e),!1}function Pt(e,t,o,r){const n=e.pieces.get(t);n&&(fo(e,t,o)||r)?(e.pieces.delete(t),je(e,n,o,r),x(e.movable.events.afterNewPiece,n.role,o,{premove:!1,predrop:!1})):n&&mo(e,t,o)?uo(e,n.role,o):(le(e),ce(e)),e.pieces.delete(t),V(e)}function Re(e,t,o){if(x(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){V(e),e.hold.cancel();return}else if((e.selectable.enabled||o)&&e.selected!==t&&St(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(At(e,t)||Ve(e,t))&&(Et(e,t),e.hold.start())}function Et(e,t){e.selected=t,Ve(e,t)?e.premovable.dests=kt(e.pieces,t,e.premovable.castle):e.premovable.dests=void 0}function V(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function At(e,t){const o=e.pieces.get(t);return!!o&&(e.movable.color==="both"||e.movable.color===o.color&&e.turnColor===o.color)}const Qe=(e,t,o)=>{var r,n;return t!==o&&At(e,t)&&(e.movable.free||!!(!((n=(r=e.movable.dests)===null||r===void 0?void 0:r.get(t))===null||n===void 0)&&n.includes(o)))};function fo(e,t,o){const r=e.pieces.get(t);return!!r&&(t===o||!e.pieces.has(o))&&(e.movable.color==="both"||e.movable.color===r.color&&e.turnColor===r.color)}function Ve(e,t){const o=e.pieces.get(t);return!!o&&e.premovable.enabled&&e.movable.color===o.color&&e.turnColor!==o.color}const go=(e,t,o)=>t!==o&&Ve(e,t)&&kt(e.pieces,t,e.premovable.castle).includes(o);function mo(e,t,o){const r=e.pieces.get(t),n=e.pieces.get(o);return!!r&&(!n||n.color!==e.movable.color)&&e.predroppable.enabled&&(r.role!=="pawn"||o[1]!=="1"&&o[1]!=="8")&&e.movable.color===r.color&&e.turnColor!==r.color}function bo(e,t){const o=e.pieces.get(t);return!!o&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===o.color&&(e.turnColor===o.color||e.premovable.enabled))}function vo(e){const t=e.premovable.current;if(!t)return!1;const o=t[0],r=t[1];let n=!1;if(Qe(e,o,r)){const i=Ct(e,o,r);if(i){const d={premove:!0};i!==!0&&(d.captured=i),x(e.movable.events.after,o,r,d),n=!0}}return le(e),n}function _o(e,t){const o=e.predroppable.current;let r=!1;if(!o)return!1;if(t(o)){const n={role:o.role,color:e.movable.color};je(e,n,o.key)&&(x(e.movable.events.afterNewPiece,o.role,o.key,{premove:!1,predrop:!0}),r=!0)}return ce(e),r}function ze(e){le(e),ce(e),V(e)}function et(e){e.movable.color=e.movable.dests=e.animation.current=void 0,ze(e)}function ge(e,t,o){let r=Math.floor(8*(e[0]-o.left)/o.width);t||(r=7-r);let n=7-Math.floor(8*(e[1]-o.top)/o.height);return t||(n=7-n),r>=0&&r<8&&n>=0&&n<8?Q([r,n]):void 0}function wo(e,t,o,r){const n=K(e),i=pt.filter(m=>wt(n[0],n[1],m[0],m[1])||bt(n[0],n[1],m[0],m[1])),d=i.map(m=>mt(Q(m),o,r)).map(m=>Se(t,m)),[,f]=d.reduce((m,v,E)=>m[0]<v?m:[v,E],[d[0],0]);return Q(i[f])}const B=e=>e.orientation==="white",Tt="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",ko={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},yo={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Nt(e){e==="start"&&(e=Tt);const t=new Map;let o=7,r=0;for(const n of e)switch(n){case" ":case"[":return t;case"/":if(--o,o<0)return t;r=0;break;case"~":{const i=t.get(Q([r-1,o]));i&&(i.promoted=!0);break}default:{const i=n.charCodeAt(0);if(i<57)r+=i-48;else{const d=n.toLowerCase();t.set(Q([r,o]),{role:ko[d],color:n===d?"black":"white"}),++r}}}return t}function Co(e){return to.map(t=>Ge.map(o=>{const r=e.get(o+t);if(r){let n=yo[r.role];return r.color==="white"&&(n=n.toUpperCase()),r.promoted&&(n+="~"),n}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function It(e,t){t.animation&&(Ze(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function Mt(e,t){var o,r,n;if(!((o=t.movable)===null||o===void 0)&&o.dests&&(e.movable.dests=void 0),!((r=t.drawable)===null||r===void 0)&&r.autoShapes&&(e.drawable.autoShapes=[]),Ze(e,t),t.fen&&(e.pieces=Nt(t.fen),e.drawable.shapes=((n=t.drawable)===null||n===void 0?void 0:n.shapes)||[]),"check"in t&&co(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&Et(e,e.selected),It(e,t),!e.movable.rookCastle&&e.movable.dests){const i=e.movable.color==="white"?"1":"8",d="e"+i,f=e.movable.dests.get(d),m=e.pieces.get(d);if(!f||!m||m.role!=="king")return;e.movable.dests.set(d,f.filter(v=>!(v==="a"+i&&f.includes("c"+i))&&!(v==="h"+i&&f.includes("g"+i))))}}function Ze(e,t){for(const o in t)Object.prototype.hasOwnProperty.call(t,o)&&(Object.prototype.hasOwnProperty.call(e,o)&&tt(e[o])&&tt(t[o])?Ze(e[o],t[o]):e[o]=t[o])}function tt(e){if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}const he=(e,t)=>t.animation.enabled?Eo(e,t):ne(e,t);function ne(e,t){const o=e(t);return t.dom.redraw(),o}const Me=(e,t)=>({key:e,pos:K(e),piece:t}),So=(e,t)=>t.sort((o,r)=>Se(e.pos,o.pos)-Se(e.pos,r.pos))[0];function Po(e,t){const o=new Map,r=[],n=new Map,i=[],d=[],f=new Map;let m,v,E;for(const[k,M]of e)f.set(k,Me(k,M));for(const k of Fe)m=t.pieces.get(k),v=f.get(k),m?v?Le(m,v.piece)||(i.push(v),d.push(Me(k,m))):d.push(Me(k,m)):v&&i.push(v);for(const k of d)v=So(k,i.filter(M=>Le(k.piece,M.piece))),v&&(E=[v.pos[0]-k.pos[0],v.pos[1]-k.pos[1]],o.set(k.key,E.concat(E)),r.push(v.key));for(const k of i)r.includes(k.key)||n.set(k.key,k.piece);return{anims:o,fadings:n}}function Ot(e,t){const o=e.animation.current;if(o===void 0){e.dom.destroyed||e.dom.redrawNow();return}const r=1-(t-o.start)*o.frequency;if(r<=0)e.animation.current=void 0,e.dom.redrawNow();else{const n=Ao(r);for(const i of o.plan.anims.values())i[2]=i[0]*n,i[3]=i[1]*n;e.dom.redrawNow(!0),requestAnimationFrame((i=performance.now())=>Ot(e,i))}}function Eo(e,t){const o=new Map(t.pieces),r=e(t),n=Po(o,t);if(n.anims.size||n.fadings.size){const i=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:n},i||Ot(t,performance.now())}else t.dom.redraw();return r}const Ao=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,To=["green","red","blue","yellow"];function No(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?V(e):ze(e);const o=fe(t),r=ge(o,B(e),e.dom.bounds());r&&(e.drawable.current={orig:r,pos:o,brush:Ko(t),snapToValidMove:e.drawable.defaultSnapToValidMove},Kt(e))}function Kt(e){requestAnimationFrame(()=>{const t=e.drawable.current;if(t){const o=ge(t.pos,B(e),e.dom.bounds());o||(t.snapToValidMove=!1);const r=t.snapToValidMove?wo(t.orig,t.pos,B(e),e.dom.bounds()):o;r!==t.mouseSq&&(t.mouseSq=r,t.dest=r!==t.orig?r:void 0,e.dom.redrawNow()),Kt(e)}})}function Io(e,t){e.drawable.current&&(e.drawable.current.pos=fe(t))}function Mo(e){const t=e.drawable.current;t&&(t.mouseSq&&qo(e.drawable,t),qt(e))}function qt(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Oo(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),Lt(e.drawable))}function Ko(e){var t;const o=(e.shiftKey||e.ctrlKey)&&gt(e),r=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return To[(o?1:0)+(r?2:0)]}function qo(e,t){const o=n=>n.orig===t.orig&&n.dest===t.dest,r=e.shapes.find(o);r&&(e.shapes=e.shapes.filter(n=>!o(n))),(!r||r.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),Lt(e)}function Lt(e){e.onChange&&e.onChange(e.shapes)}function Lo(e,t){if(!t.isTrusted||t.button!==void 0&&t.button!==0||t.touches&&t.touches.length>1)return;const o=e.dom.bounds(),r=fe(t),n=ge(r,B(e),o);if(!n)return;const i=e.pieces.get(n),d=e.selected;!d&&e.drawable.enabled&&(e.drawable.eraseOnClick||!i||i.color!==e.turnColor)&&Oo(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||i||d||Ro(e,r))&&t.preventDefault();const f=!!e.premovable.current,m=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&Qe(e,e.selected,n)?he(k=>Re(k,n),e):Re(e,n);const v=e.selected===n,E=Dt(e,n);if(i&&E&&v&&bo(e,n)){e.draggable.current={orig:n,piece:i,origPos:r,pos:r,started:e.draggable.autoDistance&&e.stats.dragged,element:E,previouslySelected:d,originTarget:t.target,keyHasChanged:!1},E.cgDragging=!0,E.classList.add("dragging");const k=e.dom.elements.ghost;k&&(k.className=`ghost ${i.color} ${i.role}`,Z(k,Pe(o)(K(n),B(e))),Ue(k,!0)),Xe(e)}else f&&le(e),m&&ce(e);e.dom.redraw()}function Ro(e,t){const o=B(e),r=e.dom.bounds(),n=Math.pow(r.width/8,2);for(const i of e.pieces.keys()){const d=mt(i,o,r);if(Se(d,t)<=n)return!0}return!1}function Do(e,t,o,r){const n="a0";e.pieces.set(n,t),e.dom.redraw();const i=fe(o);e.draggable.current={orig:n,piece:t,origPos:i,pos:i,started:!0,element:()=>Dt(e,n),originTarget:o.target,newPiece:!0,force:!!r,keyHasChanged:!1},Xe(e)}function Xe(e){requestAnimationFrame(()=>{var t;const o=e.draggable.current;if(!o)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(o.orig)&&(e.animation.current=void 0);const r=e.pieces.get(o.orig);if(!r||!Le(r,o.piece))Ae(e);else if(!o.started&&Se(o.pos,o.origPos)>=Math.pow(e.draggable.distance,2)&&(o.started=!0),o.started){if(typeof o.element=="function"){const i=o.element();if(!i)return;i.cgDragging=!0,i.classList.add("dragging"),o.element=i}const n=e.dom.bounds();Z(o.element,[o.pos[0]-n.left-n.width/16,o.pos[1]-n.top-n.height/16]),o.keyHasChanged||(o.keyHasChanged=o.orig!==ge(o.pos,B(e),n))}Xe(e)})}function Wo(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=fe(t))}function xo(e,t){const o=e.draggable.current;if(!o)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&o.originTarget!==t.target&&!o.newPiece){e.draggable.current=void 0;return}le(e),ce(e);const r=fe(t)||o.pos,n=ge(r,B(e),e.dom.bounds());n&&o.started&&o.orig!==n?o.newPiece?Pt(e,o.orig,n,o.force):(e.stats.ctrlKey=t.ctrlKey,St(e,o.orig,n)&&(e.stats.dragged=!0)):o.newPiece?e.pieces.delete(o.orig):e.draggable.deleteOnDropOff&&!n&&(e.pieces.delete(o.orig),x(e.events.change)),(o.orig===o.previouslySelected||o.keyHasChanged)&&(o.orig===n||!n)?V(e):e.selectable.enabled||V(e),Rt(e),e.draggable.current=void 0,e.dom.redraw()}function Ae(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,V(e),Rt(e),e.dom.redraw())}function Rt(e){const t=e.dom.elements;t.ghost&&Ue(t.ghost,!1)}function Dt(e,t){let o=e.dom.elements.board.firstChild;for(;o;){if(o.cgKey===t&&o.tagName==="PIECE")return o;o=o.nextSibling}}function Bo(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{ot(e,2),setTimeout(()=>ot(e,void 0),120)},120)}function ot(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function Go(e,t){function o(){ao(e),t()}return{set(r){r.orientation&&r.orientation!==e.orientation&&o(),It(e,r),(r.fen?he:ne)(n=>Mt(n,r),e)},state:e,getFen:()=>Co(e.pieces),toggleOrientation:o,setPieces(r){he(n=>lo(n,r),e)},selectSquare(r,n){r?he(i=>Re(i,r,n),e):e.selected&&(V(e),e.dom.redraw())},move(r,n){he(i=>yt(i,r,n),e)},newPiece(r,n){he(i=>je(i,r,n),e)},playPremove(){if(e.premovable.current){if(he(vo,e))return!0;e.dom.redraw()}return!1},playPredrop(r){if(e.predroppable.current){const n=_o(e,r);return e.dom.redraw(),n}return!1},cancelPremove(){ne(le,e)},cancelPredrop(){ne(ce,e)},cancelMove(){ne(r=>{ze(r),Ae(r)},e)},stop(){ne(r=>{et(r),Ae(r)},e)},explode(r){Bo(e,r)},setAutoShapes(r){ne(n=>n.drawable.autoShapes=r,e)},setShapes(r){ne(n=>n.drawable.shapes=r,e)},getKeyAtDomPos(r){return ge(r,B(e),e.dom.bounds())},redrawAll:t,dragNewPiece(r,n,i){Do(e,r,n,i)},destroy(){et(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function $o(){return{pieces:Nt(Tt),orientation:"white",turnColor:"white",coordinates:!0,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},prevSvgHash:""},hold:ro()}}function De(e,t,o){const r=new Map,n=[];for(const f of e)r.set(f.hash,!1);let i=t.firstChild,d;for(;i;)d=i.getAttribute("cgHash"),r.has(d)?r.set(d,!0):n.push(i),i=i.nextSibling;for(const f of n)t.removeChild(f);for(const f of e)r.get(f.hash)||t.appendChild(o(f))}function z(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function Fo(e,t,o){const r=e.drawable,n=r.current,i=n&&n.mouseSq?n:void 0,d=new Map,f=e.dom.bounds(),m=r.autoShapes.filter(y=>!y.piece);for(const y of r.shapes.concat(m).concat(i?[i]:[]))y.dest&&d.set(y.dest,(d.get(y.dest)||0)+1);const v=r.shapes.concat(m).map(y=>({shape:y,current:!1,hash:rt(y,d,!1,f)}));i&&v.push({shape:i,current:!0,hash:rt(i,d,!0,f)});const E=v.map(y=>y.hash).join(";");if(E===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=E;const k=t.querySelector("defs"),M=t.querySelector("g"),D=o.querySelector("g");Ho(r,v,k),De(v.filter(y=>!y.shape.customSvg),M,y=>nt(e,y,r.brushes,d,f)),De(v.filter(y=>y.shape.customSvg),D,y=>nt(e,y,r.brushes,d,f))}function Ho(e,t,o){const r=new Map;let n;for(const f of t)f.shape.dest&&(n=e.brushes[f.shape.brush],f.shape.modifiers&&(n=Wt(n,f.shape.modifiers)),r.set(n.key,n));const i=new Set;let d=o.firstChild;for(;d;)i.add(d.getAttribute("cgKey")),d=d.nextSibling;for(const[f,m]of r.entries())i.has(f)||o.appendChild(Xo(m))}function rt({orig:e,dest:t,brush:o,piece:r,modifiers:n,customSvg:i},d,f,m){return[m.width,m.height,f,e,t,o,t&&(d.get(t)||0)>1,r&&Uo(r),n&&jo(n),i&&Qo(i)].filter(v=>v).join(",")}function Uo(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function jo(e){return""+(e.lineWidth||"")}function Qo(e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e.charCodeAt(o)>>>0;return"custom-"+t.toString()}function nt(e,{shape:t,current:o,hash:r},n,i,d){let f;const m=st(K(t.orig),e.orientation);if(t.customSvg)f=Vo(t.customSvg,m,d);else if(t.dest){let v=n[t.brush];t.modifiers&&(v=Wt(v,t.modifiers)),f=Zo(v,m,st(K(t.dest),e.orientation),o,(i.get(t.dest)||0)>1,d)}else f=zo(n[t.brush],m,o,d);return f.setAttribute("cgHash",r),f}function Vo(e,t,o){const[r,n]=Te(t,o),i=ae(z("g"),{transform:`translate(${r},${n})`}),d=ae(z("svg"),{width:1,height:1,viewBox:"0 0 100 100"});return i.appendChild(d),d.innerHTML=e,i}function zo(e,t,o,r){const n=Te(t,r),i=Yo(),d=(r.width+r.height)/(4*Math.max(r.width,r.height));return ae(z("circle"),{stroke:e.color,"stroke-width":i[o?0:1],fill:"none",opacity:xt(e,o),cx:n[0],cy:n[1],r:d-i[1]/2})}function Zo(e,t,o,r,n,i){const d=er(n&&!r),f=Te(t,i),m=Te(o,i),v=m[0]-f[0],E=m[1]-f[1],k=Math.atan2(E,v),M=Math.cos(k)*d,D=Math.sin(k)*d;return ae(z("line"),{stroke:e.color,"stroke-width":Jo(e,r),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:xt(e,r),x1:f[0],y1:f[1],x2:m[0]-M,y2:m[1]-D})}function Xo(e){const t=ae(z("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return t.appendChild(ae(z("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function ae(e,t){for(const o in t)Object.prototype.hasOwnProperty.call(t,o)&&e.setAttribute(o,t[o]);return e}function st(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function Wt(e,t){return{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(o=>o).join("")}}function Yo(){return[3/64,4/64]}function Jo(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function xt(e,t){return(e.opacity||1)*(t?.9:1)}function er(e){return(e?20:10)/64}function Te(e,t){const o=Math.min(1,t.width/t.height),r=Math.min(1,t.height/t.width);return[(e[0]-3.5)*o,(3.5-e[1])*r]}function tr(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(const m of eo)e.classList.toggle("orientation-"+m,t.orientation===m);e.classList.toggle("manipulable",!t.viewOnly);const o=J("cg-container");e.appendChild(o);const r=J("cg-board");o.appendChild(r);let n,i,d;if(t.drawable.visible&&(n=ae(z("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),n.appendChild(z("defs")),n.appendChild(z("g")),i=ae(z("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild(z("g")),d=J("cg-auto-pieces"),o.appendChild(n),o.appendChild(i),o.appendChild(d)),t.coordinates){const m=t.orientation==="black"?" black":"",v=t.ranksPosition==="left"?" left":"";o.appendChild(it($e,"ranks"+m+v)),o.appendChild(it(Ge,"files"+m))}let f;return t.draggable.enabled&&t.draggable.showGhost&&(f=J("piece","ghost"),Ue(f,!1),o.appendChild(f)),{board:r,container:o,wrap:e,ghost:f,svg:n,customSvg:i,autoPieces:d}}function it(e,t){const o=J("coords",t);let r;for(const n of e)r=J("coord"),r.textContent=n,o.appendChild(r);return o}function or(e,t){if(!e.dropmode.active)return;le(e),ce(e);const o=e.dropmode.piece;if(o){e.pieces.set("a0",o);const r=fe(t),n=r&&ge(r,B(e),e.dom.bounds());n&&Pt(e,"a0",n)}e.dom.redraw()}function rr(e,t){const o=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",n=>n.preventDefault()),e.viewOnly)return;const r=sr(e);o.addEventListener("touchstart",r,{passive:!1}),o.addEventListener("mousedown",r,{passive:!1})}function nr(e,t){const o=[];if("ResizeObserver"in window||o.push(we(document.body,"chessground.resize",t)),!e.viewOnly){const r=at(e,Wo,Io),n=at(e,xo,Mo);for(const d of["touchmove","mousemove"])o.push(we(document,d,r));for(const d of["touchend","mouseup"])o.push(we(document,d,n));const i=()=>e.dom.bounds.clear();o.push(we(document,"scroll",i,{capture:!0,passive:!0})),o.push(we(window,"resize",i,{passive:!0}))}return()=>o.forEach(r=>r())}function we(e,t,o,r){return e.addEventListener(t,o,r),()=>e.removeEventListener(t,o,r)}const sr=e=>t=>{e.draggable.current?Ae(e):e.drawable.current?qt(e):t.shiftKey||gt(t)?e.drawable.enabled&&No(e,t):e.viewOnly||(e.dropmode.active?or(e,t):Lo(e,t))},at=(e,t,o)=>r=>{e.drawable.current?e.drawable.enabled&&o(e,r):e.viewOnly||t(e,r)};function ir(e){const t=B(e),o=Pe(e.dom.bounds()),r=e.dom.elements.board,n=e.pieces,i=e.animation.current,d=i?i.plan.anims:new Map,f=i?i.plan.fadings:new Map,m=e.draggable.current,v=lr(e),E=new Set,k=new Set,M=new Map,D=new Map;let y,S,G,ee,$,F,X,H,R,Y;for(S=r.firstChild;S;){if(y=S.cgKey,Bt(S))if(G=n.get(y),$=d.get(y),F=f.get(y),ee=S.cgPiece,S.cgDragging&&(!m||m.orig!==y)&&(S.classList.remove("dragging"),Z(S,o(K(y),t)),S.cgDragging=!1),!F&&S.cgFading&&(S.cgFading=!1,S.classList.remove("fading")),G){if($&&S.cgAnimating&&ee===ke(G)){const T=K(y);T[0]+=$[2],T[1]+=$[3],S.classList.add("anim"),Z(S,o(T,t))}else S.cgAnimating&&(S.cgAnimating=!1,S.classList.remove("anim"),Z(S,o(K(y),t)),e.addPieceZIndex&&(S.style.zIndex=Oe(K(y),t)));ee===ke(G)&&(!F||!S.cgFading)?E.add(y):F&&ee===ke(F)?(S.classList.add("fading"),S.cgFading=!0):Ke(M,ee,S)}else Ke(M,ee,S);else if(Gt(S)){const T=S.className;v.get(y)===T?k.add(y):Ke(D,T,S)}S=S.nextSibling}for(const[T,de]of v)if(!k.has(T)){R=D.get(de),Y=R&&R.pop();const q=o(K(T),t);if(Y)Y.cgKey=T,Z(Y,q);else{const U=J("square",de);U.cgKey=T,Z(U,q),r.insertBefore(U,r.firstChild)}}for(const[T,de]of n)if($=d.get(T),!E.has(T))if(X=M.get(ke(de)),H=X&&X.pop(),H){H.cgKey=T,H.cgFading&&(H.classList.remove("fading"),H.cgFading=!1);const q=K(T);e.addPieceZIndex&&(H.style.zIndex=Oe(q,t)),$&&(H.cgAnimating=!0,H.classList.add("anim"),q[0]+=$[2],q[1]+=$[3]),Z(H,o(q,t))}else{const q=ke(de),U=J("piece",q),te=K(T);U.cgPiece=q,U.cgKey=T,$&&(U.cgAnimating=!0,te[0]+=$[2],te[1]+=$[3]),Z(U,o(te,t)),e.addPieceZIndex&&(U.style.zIndex=Oe(te,t)),r.appendChild(U)}for(const T of M.values())ct(e,T);for(const T of D.values())ct(e,T)}function ar(e){const t=B(e),o=Pe(e.dom.bounds());let r=e.dom.elements.board.firstChild;for(;r;)(Bt(r)&&!r.cgAnimating||Gt(r))&&Z(r,o(K(r.cgKey),t)),r=r.nextSibling}function lt(e){var t,o;const r=e.dom.elements.wrap.getBoundingClientRect(),n=e.dom.elements.container,i=r.height/r.width,d=Math.floor(r.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,f=d*i;n.style.width=d+"px",n.style.height=f+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("--cg-width",d+"px"),(o=e.addDimensionsCssVarsTo)===null||o===void 0||o.style.setProperty("--cg-height",f+"px")}const Bt=e=>e.tagName==="PIECE",Gt=e=>e.tagName==="SQUARE";function ct(e,t){for(const o of t)e.dom.elements.board.removeChild(o)}function Oe(e,t){const o=e[1];return`${t?3+7-o:3+o}`}const ke=e=>`${e.color} ${e.role}`;function lr(e){var t;const o=new Map;if(e.lastMove&&e.highlight.lastMove)for(const i of e.lastMove)re(o,i,"last-move");if(e.check&&e.highlight.check&&re(o,e.check,"check"),e.selected&&(re(o,e.selected,"selected"),e.movable.showDests)){const i=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(i)for(const f of i)re(o,f,"move-dest"+(e.pieces.has(f)?" oc":""));const d=e.premovable.dests;if(d)for(const f of d)re(o,f,"premove-dest"+(e.pieces.has(f)?" oc":""))}const r=e.premovable.current;if(r)for(const i of r)re(o,i,"current-premove");else e.predroppable.current&&re(o,e.predroppable.current.key,"current-premove");const n=e.exploding;if(n)for(const i of n.keys)re(o,i,"exploding"+n.stage);return o}function re(e,t,o){const r=e.get(t);r?e.set(t,`${r} ${o}`):e.set(t,o)}function Ke(e,t,o){const r=e.get(t);r?r.push(o):e.set(t,[o])}function cr(e,t){const o=e.drawable.autoShapes.filter(r=>r.piece).map(r=>({shape:r,hash:ur(r),current:!1}));De(o,t,r=>hr(e,r,e.dom.bounds()))}function dr(e){var t;const o=B(e),r=Pe(e.dom.bounds());let n=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;n;)ft(n,r(K(n.cgKey),o),n.cgScale),n=n.nextSibling}function hr(e,{shape:t,hash:o},r){var n,i,d;const f=t.orig,m=(n=t.piece)===null||n===void 0?void 0:n.role,v=(i=t.piece)===null||i===void 0?void 0:i.color,E=(d=t.piece)===null||d===void 0?void 0:d.scale,k=J("piece",`${m} ${v}`);return k.setAttribute("cgHash",o),k.cgKey=f,k.cgScale=E,ft(k,Pe(r)(K(f),B(e)),E),k}const ur=e=>{var t,o,r;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(o=e.piece)===null||o===void 0?void 0:o.color,(r=e.piece)===null||r===void 0?void 0:r.scale].join(",")};function pr(e,t){const o=$o();Mt(o,t||{});function r(){const n="dom"in o?o.dom.unbind:void 0,i=tr(e,o),d=oo(()=>i.board.getBoundingClientRect()),f=E=>{ir(v),i.autoPieces&&cr(v,i.autoPieces),!E&&i.svg&&Fo(v,i.svg,i.customSvg)},m=()=>{lt(v),ar(v),i.autoPieces&&dr(v)},v=o;return v.dom={elements:i,bounds:d,redraw:fr(f),redrawNow:f,unbind:n},v.drawable.prevSvgHash="",lt(v),f(!1),rr(v,m),n||(v.dom.unbind=nr(v,m)),v.events.insert&&v.events.insert(i),v}return Go(r(),r)}function fr(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}function me(e){const t=[];for(const o of e)t.push({orig:o.to,brush:"yellow"}),o.captured&&t.push({orig:o.from,dest:o.to,brush:"red"}),o.san.includes("+")&&t.push({orig:o.from,dest:o.to,brush:"blue"});return t}function ue(e){return e==="w"?"white":"black"}function gr(e){switch(e){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return"pawn"}}function ie(e){const t=new Map;for(const o of Be.SQUARES){const r=e.moves({square:o,verbose:!0});r.length&&t.set(r[0].from,r.map(n=>n.to))}return t}function mr(e,t){if((t==null?void 0:t.type)!=="p")return!1;const o=(t==null?void 0:t.color)==="w"?"8":"1";return e[1]===o}function $t(e,t){for(const o of Object.keys(t))t[o]instanceof Object&&Object.assign(t[o],$t(e[o],t[o]));return Object.assign(e||{},t),e}function Ne(e,t,o){if(e.inCheck()){const n=t.state.pieces;for(const[i,d]of n)if(d.role==="king"&&d.color===(t==null?void 0:t.state.turnColor)){t.state.check=i,o("check",t.state.turnColor),e.isCheckmate()&&o("checkmate",t.state.turnColor);return}}e.isDraw()&&o("draw",!0),e.isStalemate()&&o("stalemate",!0);const r=e.history({verbose:!0}).pop();typeof r<"u"&&o("move",r)}class br{constructor(t,o,r,n){ve(this,"game");ve(this,"board");ve(this,"boardState");ve(this,"emit");this.game=t,this.board=o,this.boardState=r,this.emit=n}resetBoard(){this.game.reset(),this.board.redrawAll(),this.board.set(this.boardState.boardConfig),this.board.state.check=void 0,this.board.selectSquare(null),this.boardState.showThreats&&this.board.setShapes(me(this.game.moves({verbose:!0})))}undoLastMove(){if(this.game.undo()==null)return;const t=this.game.history({verbose:!0}).at(-1);this.board.set({fen:this.game.fen()}),this.board.state.turnColor=ue(this.game.turn()),this.board.state.movable.color=this.boardState.playerColor||this.board.state.turnColor,this.board.state.movable.dests=ie(this.game),this.board.state.check=void 0,this.game.history().length===0||typeof t>"u"?this.board.state.lastMove=void 0:this.board.state.lastMove=[t==null?void 0:t.from,t==null?void 0:t.to],this.boardState.showThreats&&this.board.setShapes(me(this.game.moves({verbose:!0})))}getMaterialCount(){const t=this.board.state.pieces,o=new Map([["pawn",1],["knight",3],["bishop",3],["rook",5],["queen",9],["king",0]]),r={materialWhite:0,materialBlack:0,materialDiff:0};for(const n of t)n[1].color==="white"?r.materialWhite+=o.get(n[1].role)||0:r.materialBlack+=o.get(n[1].role)||0;return r.materialDiff=r.materialWhite-r.materialBlack,r}toggleOrientation(){this.board.toggleOrientation()}drawMoves(){this.boardState.showThreats=!0,this.board.setShapes(me(this.game.moves({verbose:!0})))}hideMoves(){this.boardState.showThreats=!1,this.board.setShapes([])}drawMove(t,o,r){this.board.setShapes([{orig:t,dest:o,brush:r}])}toggleMoves(){this.boardState.showThreats=!this.boardState.showThreats,this.boardState.showThreats?this.board.setShapes(me(this.game.moves({verbose:!0}))):this.board.setShapes([])}async getOpeningName(){var t;try{const o=this.game.history({verbose:!0}).map(r=>r.lan).join(",");return((t=(await(await fetch(`https://explorer.lichess.ovh/masters?play=${o}`)).json()).opening)==null?void 0:t.name)??null}catch{return null}}move(t){var r;const o=this.game.move(t);if(o==null)return!1;if(t==="O-O-O"||t==="O-O"){const n=o.to[1];t==="O-O-O"?this.board.move(`a${n}`,`d${n}`):this.board.move(`h${n}`,`f${n}`)}if(o.promotion){this.board.state.pieces.set(o.to,{color:ue(o.color),role:gr(o.promotion),promoted:!0}),this.board.state.pieces.delete(o.from),this.board.redrawAll();const n=o.promotion.toUpperCase();this.emit("promotion",{color:((r=this.board)==null?void 0:r.state.turnColor)==="white"?"black":"white",promotedTo:n,sanMove:o.san})}else this.board.move(o.from,o.to);return this.board.state.movable.dests=ie(this.game),this.board.state.turnColor=ue(this.game.turn()),this.board.state.movable.color=this.boardState.playerColor||this.board.state.turnColor,this.board.state.lastMove=[o.from,o.to],this.boardState.showThreats&&this.board.setShapes(me(this.game.moves({verbose:!0}))),Ne(this.game,this.board,this.emit),!0}getTurnColor(){return this.board.state.turnColor}getPossibleMoves(){return ie(this.game)}getCurrentTurnNumber(){let t=this.game.history().length;return t%2===0&&t!==0&&(t+=1),Math.ceil(t/2)}getLastMoveTurnNumber(){return Math.ceil(this.game.history().length/2)}getLastMove(){return this.game.history({verbose:!0}).at(-1)}getHistory(t=!1){return this.game.history({verbose:t})}getFen(){return this.game.fen()}getBoardPosition(){return this.game.board()}getPgn(){return this.game.pgn()}getIsGameOver(){return this.game.isGameOver()}getIsCheckmate(){return this.game.isCheckmate()}getIsStalemate(){return this.game.isStalemate()}getIsDraw(){return this.game.isDraw()}getIsThreefoldRepetition(){return this.game.isThreefoldRepetition()}getIsInsufficientMaterial(){return this.game.isInsufficientMaterial()}getSquareColor(t){return this.game.squareColor(t)}getSquare(t){return this.game.get(t)}setPosition(t){this.game.load(t),this.updateGameState()}putPiece(t,o){return this.game.put(t,o)}clearBoard(){this.game.clear()}setShapes(t){this.board.setShapes(t)}loadPgn(t){this.game.loadPgn(t),this.updateGameState()}updateGameState(){this.board.set({fen:this.game.fen()}),this.board.state.turnColor=ue(this.game.turn()),this.board.state.movable.color=this.boardState.playerColor||this.board.state.turnColor,this.board.state.movable.dests=ie(this.game),Ne(this.game,this.board,this.emit)}getPgnInfo(){return this.game.header()}}const vr=new Map([["b1",["a3","c3"]],["g1",["f3","h3"]],["a2",["a3","a4"]],["b2",["b3","b4"]],["c2",["c3","c4"]],["d2",["d3","d4"]],["e2",["e3","e4"]],["f2",["f3","f4"]],["g2",["g3","g4"]],["h2",["h3","h4"]]]),_r="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",qe={fen:_r,orientation:"white",turnColor:"white",coordinates:!1,autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:300},lastMove:void 0,movable:{free:!1,color:"white",showDests:!0,dests:vr,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},selectable:{enabled:!0},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}}}},wr={class:"main-board"},kr={class:"dialog-container"},yr=dt({__name:"TheChessboard",props:{boardConfig:{type:Object,default:qe},playerColor:{type:[String,void 0],default:null}},emits:["boardCreated","checkmate","stalemate","draw","check","promotion","move"],setup(e,{emit:t}){const o=e;let r;const n=be(null),i=new Be.Chess,d=be("white"),f=be(),m=be({showThreats:!1,boardConfig:{},openPromotionDialog:!1,playerColor:o.playerColor});jt(()=>{if(n.value==null)throw new Error("vue3-chessboard: Failed to mount board.");o.boardConfig?m.value.boardConfig=$t(qe,o.boardConfig):m.value.boardConfig=qe,o.playerColor&&(m.value.boardConfig.movable={color:o.playerColor,dests:ie(i)}),o.boardConfig.fen&&(i.load(o.boardConfig.fen),m.value.boardConfig.turnColor=ue(i.turn()),m.value.boardConfig.check=i.inCheck(),m.value.boardConfig.movable={color:o.playerColor||m.value.boardConfig.turnColor,dests:ie(i)}),r=pr(n.value,m.value.boardConfig),r.set({movable:{events:{after:E()},dests:ie(i)}}),d.value=ue(i.turn()),t("boardCreated",new br(i,r,m.value,t)),Ne(i,r,t)});async function v(){return d.value=ue(i.turn()),m.value.openPromotionDialog=!0,new Promise(k=>Vt(f,()=>k(f.value)))}function E(){return async(k,M)=>{var D;if(typeof r>"u"){console.error("vue3-chessboard: No board element found");return}if(mr(M,i.get(k))){await v(),m.value.openPromotionDialog=!1;const y=(D=f.value)==null?void 0:D.toUpperCase(),S=`${k[0]}x${M}=${y}`;t("promotion",{color:r.state.turnColor,sanMove:S,promotedTo:y})}i.move({from:k,to:M,promotion:f.value}),f.value=void 0,r.set({animation:{enabled:!1},fen:i.fen(),turnColor:r.state.turnColor,movable:{color:o.playerColor||r.state.turnColor,dests:ie(i)}}),r.set({animation:{enabled:!0}}),Ne(i,r,t),m.value.showThreats&&r.setShapes(me(i.moves({verbose:!0})))}}return(k,M)=>(Ce(),ht("section",{class:ye(["main-wrap",{disabledBoard:m.value.openPromotionDialog}])},[se("div",wr,[se("div",kr,[m.value.openPromotionDialog?(Ce(),xe(Jt,{key:0,"turn-color":d.value,onPromotionSelected:M[0]||(M[0]=D=>f.value=D)},null,8,["turn-color"])):ut("",!0)]),se("div",{ref_key:"boardElement",ref:n},null,512)])],2))}});const Cr={key:0},We=be(),Sr={data(){return{gameState:"",playerColor:null}},computed:{computedBoardConfig(){const e={orientation:this.playerColor,moveable:{free:!1}};return console.log(e),e}},mounted(){_e.subscribeEvent("SetGameState",this.setGameState),_e.subscribeEvent("GameEnd",this.gameEnd),_e.getGameState(this.$store.state.infos.currentGameGuid),_e.getColor(this.$store.state.infos.currentGameGuid,this.$store.state.infos.username).then(e=>{this.playerColor=e})},methods:{gameEnd(e){console.log("Game ended, winner is "+e)},handleMove(e){console.log(e);let t=e.after;_e.setGameState(this.$store.state.infos.currentGameGuid,t)},setGameState(e){console.log(this.playerColor),We.value&&We.value.setPosition(e[0]),console.log(this.computedBoardConfig),console.log(e[0])}}},Ar=Object.assign(Sr,{__name:"GameView",setup(e){return(t,o)=>{const r=zt("center");return Ce(),xe(r,null,{default:Zt(()=>[t.playerColor==="white"||t.playerColor==="black"?(Ce(),ht("div",Cr,[Xt(Yt(yr),{"board-config":t.computedBoardConfig,"player-color":t.playerColor,onBoardCreated:o[0]||(o[0]=n=>We.value=n),onCheckmate:t.gameEnd,onMove:t.handleMove},null,8,["board-config","player-color","onCheckmate","onMove"])])):ut("",!0)]),_:1})}}});export{Ar as default};
